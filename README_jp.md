# QAM Mapperブロック説明書

## 1. 概要

**QAM Mapper**は、GNU Radioフレームワーク向けのカスタム同期ブロックです。入力バイトデータ（`unsigned char`）を指定されたQAM（直交振幅変調）コンスタレーションの複素数点にマッピングします。QAM-64（8x8グリッド）およびQAM-128（8x16グリッド）をサポートし、グレイコードマッピングの有効/無効を選択可能です。

このブロックは、デジタル通信システム（例：DVB、5G、Wi-Fi）での変調処理に適しており、効率的なNumPyベクトル化と堅牢なエラーハンドリングを実装しています。

## 2. 機能

- **入力**: 8ビット符号なし整数（`uint8`）の配列。各値はQAMコンスタレーションのインデックスを表します。
- **出力**: 複素数（`complex64`）の配列で、単位平均パワー（1）に正規化されたQAMシンボル。
- **設定可能なパラメータ**:
  - **QAM Size**: コンスタレーションサイズ（64または128）。
  - **Enable Gray Mapping**: グレイコードマッピングを適用するかどうか。
- **特徴**:
  - QAM-64（8x8グリッド）およびQAM-128（8x16グリッド）をサポート。
  - グレイコード変換/逆変換を効率的に処理。
  - 入力値の範囲チェックとエラーログ出力。
  - NumPyベクトル化による高パフォーマンス。

## 3. 依存関係

- **GNU Radio**: 同期ブロックの基盤として必要。
- **NumPy**: 配列操作とコンスタレーション生成に使用。
- **utils.py**: `generate_constellation`関数と`GrayCoder`クラスを含むユーティリティモジュール。

## 4. インストール

1. **ブロックの配置**:
   - XML定義ファイル（`qam_mapper.xml`）をGNU Radioのブロックディレクトリ（例: `~/.grc_gnuradio/`）に配置。
   - Python実装コードを`make_block`セクションから適切な`.py`ファイル（例: `qam_mapper.py`）として保存。
2. **ユーティリティモジュールの配置**:
   - `utils.py`をプロジェクトのPythonパス（例: `PYTHONPATH`）に配置。
3. **依存ライブラリの確認**:
   ```bash
   pip install numpy

GNU Radioがインストール済みであることを確認。

4. **GRCでの使用**:
GNU Radio Companion（GRC）でブロックをインポートし、フローに追加。

## 5. **パラメータ**:

|パラメータ名|型|デフォルト|説明|
| ---- | ---- | ---- | ---- |
|qam_size|int|128|QAMコンスタレーションサイズ（64または128）。|
|enable_gray_map|bool|True|グレイコードマッピングを有効化。|

パラメータ詳細
QAM Size:
64: 8x8グリッド（64点）のQAMコンスタレーション。

128: 8x16グリッド（128点）のQAMコンスタレーション。

その他の値はサポートされず、ValueErrorが発生します。

Enable Gray Mapping:
True: 入力値をグレイコードからバイナリに変換後、コンスタレーションにマッピング。

False: 入力値を直接コンスタレーションのインデックスとして使用。

## 6. **入力と出力**
入力: unsigned char（uint8）
範囲: 0 から qam_size-1（例: QAM-64なら0～63、QAM-128なら0～127）。

範囲外の値は0j（複素数ゼロ）にマッピングされ、警告ログが出力されます。

出力: complex float（complex64）
単位平均パワー（1）に正規化されたQAMシンボル。

## 7. **ユーティリティ関数（utils.py）**
QAM Mapperブロックは、以下のユーティリティ関数/クラスに依存します。
## 7.1 **generate_constellation**
機能: 指定されたQAMサイズに基づき、単位平均パワーに正規化されたコンスタレーションを生成。

引数:
qam_size (int): QAMサイズ（64または128）。

戻り値: np.ndarray（複素数配列）。

詳細:
QAM-64: 8x8グリッド（各軸8点、座標は{-7,-5,-3,-1,1,3,5,7}）。

QAM-128: 8x16グリッド（I軸8点、Q軸16点）。

平均パワーを1に正規化。

無効なqam_sizeはValueErrorを投げる。

## 7.2 **GrayCoderクラス**
機能: グレイコードの変換（バイナリ→グレイ）と逆変換（グレイ→バイナリ）を提供。

メソッド:
__init__(qam_size): QAMサイズに基づき、必要なビット数とマスクを初期化。

to_gray(vals): バイナリ値をグレイコードに変換。

from_gray(vals): グレイコードをバイナリ値に変換。

特徴:
NumPy配列に対応し、複数値の一括処理が可能。

QAMサイズに応じたビット数で値を制限（例: QAM-64は6ビット、QAM-128は7ビット）。

## 8. **使用例（GNU Radio Companion）**
フローの構築:
入力: Vector Source（uint8）でテストデータ（例: [0, 1, 2, ..., 63]）を生成。

QAM Mapper: パラメータを設定（例: qam_size=64, enable_gray_map=True）。

出力: QT GUI Constellation Sinkでコンスタレーションを可視化。

設定例:
QAM-64、グレイマッピング有効:

   ```plaintext
     QAM Size: 64
    Enable Gray Mapping: True
   ```


入力[0, 1, 2, 3]はグレイコード逆変換後、対応するコンスタレーション点にマッピング。

実行:
GRCでフローを実行し、コンスタレーション図を確認。

範囲外の入力値（例: 64以上の値）は0jにマッピングされ、ログに警告が出力。

## 9. **エラーハンドリング**
無効なQAMサイズ: qam_sizeが64または128以外の場合は、ValueErrorが発生。

無効な入力値: 入力値が0未満またはqam_size以上の場合、0jを出力し、警告ログを記録。

コンスタレーションエラー: generate_constellationが期待するサイズの配列を返さない場合、ValueErrorが発生。



